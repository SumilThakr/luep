# UK Soil NOx Post-Processing Documentation

This document describes the post-processing scripts for cropping global soil NOx emissions to UK extents, enabling UK-focused analysis while preserving global outputs.

## Overview

The UK soil NOx post-processing system takes global soil NOx emissions calculated using the Yan et al. (2005) model with scenario-specific nitrogen inputs and crops them to UK geographic extents. This enables:

- **UK-focused policy analysis** with reduced file sizes
- **Direct comparison** with UK land-use scenarios  
- **Preserved global outputs** for broader analysis
- **Consistent spatial alignment** across all scenarios

## Scripts Description

### 1. `soil_nox_uk_postprocessing.py`
**Purpose**: Main script for cropping individual scenarios to UK extent

**Usage**:
```bash
# Basic cropping
python soil_nox_uk_postprocessing.py extensification_current_practices

# With validation outputs
python soil_nox_uk_postprocessing.py forestry_expansion --validate
```

**Key Functions**:
- `get_uk_scenario_reference()` - Finds UK land-use map for spatial reference
- `crop_global_to_uk_extent()` - Performs spatial cropping using pygeoprocessing
- `generate_uk_statistics()` - Calculates UK-specific emission statistics
- `compare_global_vs_uk()` - Generates comparison between global and UK totals

### 2. `batch_crop_uk_soil_nox.py`
**Purpose**: Batch processing script for all 15 UK scenarios

**Usage**:
```bash
# Process all scenarios
python batch_crop_uk_soil_nox.py

# With validation and cross-scenario analysis
python batch_crop_uk_soil_nox.py --validate

# Show help
python batch_crop_uk_soil_nox.py --help
```

**Key Functions**:
- `process_all_uk_cropping()` - Batch processes all scenarios
- `check_prerequisites()` - Validates that global emissions exist
- `generate_validation_summary()` - Creates cross-scenario comparison
- `save_batch_summary()` - Documents processing results

## File Structure

### Input Files
```
outputs/uk_results/{scenario}/
├── nox_emissions.tif         # Global soil NOx emissions (required)
└── soil_nox_summary.txt     # Global statistics (optional)

scenarios/UKNatureFrontierWithAir/United Kingdom/ScenarioMaps/
└── {scenario}.tif            # UK land-use maps (spatial reference)
```

### Output Files
```
outputs/uk_results/{scenario}/
├── nox_emissions.tif              # Global emissions (preserved)
├── nox_emissions_uk.tif          # NEW: UK-cropped emissions
├── soil_nox_summary.txt          # Global statistics (preserved)
├── soil_nox_summary_uk.txt       # NEW: UK-specific statistics
└── global_vs_uk_comparison.txt   # NEW: Comparison (if --validate)

outputs/uk_results/
├── uk_cropping_summary.txt       # Batch processing summary
└── uk_validation_summary.txt     # Cross-scenario validation
```

## Technical Details

### Spatial Processing

**UK Geographic Bounds**: 
- Longitude: -8.17° to 1.77°E  
- Latitude: 49.91° to 60.85°N
- Coordinate System: WGS84 Geographic (EPSG:4326)

**Processing Method**:
1. **Spatial Reference**: Uses UK land-use scenario maps to define exact bounds
2. **Alignment**: `pygeoprocessing.align_and_resize_raster_stack()` with bilinear resampling
3. **Cropping**: Bounding box intersection to extract UK extent
4. **Validation**: Pixel count and area verification

### Statistics Calculation

**UK-Specific Metrics**:
- Total UK soil NOx emissions
- Mean, median, min, max emission values
- Emission percentiles (10th, 25th, 75th, 90th, 95th, 99th)
- Valid pixel count and total area
- Geographic bounds verification

**Pixel Area Calculation**:
```python
# For geographic coordinates (degrees)
lat_to_m = 111000  # meters per degree latitude
lon_to_m = 111000 * cos(center_latitude)  # longitude varies by latitude
pixel_area_ha = (pixel_width * lon_to_m * pixel_height * lat_to_m) / 10000
```

## Prerequisites

### Software Environment
```bash
# Use rasters conda environment
/Users/sumilthakrar/yes/envs/rasters/bin/python soil_nox_scripts/batch_crop_uk_soil_nox.py
```

### Required Dependencies
- `pygeoprocessing` - Spatial raster processing
- `osgeo` (GDAL) - Geospatial data handling
- `numpy` - Array operations
- Standard Python libraries

### Input Data Requirements
1. **Global soil NOx emissions** - Must exist for all scenarios
   - Generated by: `process_all_uk_soil_nox.py`
   - Format: GeoTIFF raster files
   - Extent: Global coverage

2. **UK land-use scenario maps** - For spatial reference
   - Location: `scenarios/UKNatureFrontierWithAir/United Kingdom/ScenarioMaps/`
   - Format: GeoTIFF raster files  
   - Extent: UK geographic bounds

## Usage Examples

### Single Scenario Processing
```bash
# Basic UK cropping
cd /Users/sumilthakrar/Desktop/UK/luep
/Users/sumilthakrar/yes/envs/rasters/bin/python \
  soil_nox_scripts/soil_nox_uk_postprocessing.py extensification_current_practices

# With validation
/Users/sumilthakrar/yes/envs/rasters/bin/python \
  soil_nox_scripts/soil_nox_uk_postprocessing.py forestry_expansion --validate
```

### Batch Processing
```bash
# Process all 15 scenarios
/Users/sumilthakrar/yes/envs/rasters/bin/python \
  soil_nox_scripts/batch_crop_uk_soil_nox.py

# With comprehensive validation
/Users/sumilthakrar/yes/envs/rasters/bin/python \
  soil_nox_scripts/batch_crop_uk_soil_nox.py --validate
```

### Integration with Main Workflow
```bash
# Complete workflow: Global processing + UK cropping
/Users/sumilthakrar/yes/envs/rasters/bin/python process_all_uk_soil_nox.py
/Users/sumilthakrar/yes/envs/rasters/bin/python soil_nox_scripts/batch_crop_uk_soil_nox.py --validate
```

## Output Interpretation

### UK Statistics File (`soil_nox_summary_uk.txt`)
```
UK Soil NOx Emissions Summary (UK Extent)
==================================================

Scenario: extensification_current_practices
Generated: 2024-06-18 18:45:30
Processing: Cropped from global output to UK extent

SPATIAL EXTENT:
------------------------------
Longitude range: -8.170 to 1.770
Latitude range: 49.910 to 60.850
Total pixels: 1,234,567
Valid pixels: 987,654
Pixel area: 0.005401 hectares per pixel
Total area: 5,335.2 hectares

UK SOIL NOx EMISSIONS:
------------------------------
Min emission: 0.000012
Max emission: 8.543210
Mean emission: 0.234567
Median emission: 0.156789
Std deviation: 0.345678
Total UK emission: 231,456.78
```

### Cross-Scenario Validation (`uk_validation_summary.txt`)
```
SCENARIO COMPARISON:
----------------------------------------
Scenario                     | Total Emission  | Mean Emission | Pixels
---------------------------------------------------------------------------
extensification_current      |        231,457  |     0.234567  |  987,654
forestry_expansion           |        123,456  |     0.125789  |  987,654
restoration                  |         89,123  |     0.090345  |  987,654
```

## Troubleshooting

### Common Issues

**1. Missing Global Emissions**
```
❌ Global soil NOx file not found: outputs/uk_results/{scenario}/nox_emissions.tif
```
**Solution**: Run global processing first:
```bash
/Users/sumilthakrar/yes/envs/rasters/bin/python process_all_uk_soil_nox.py
```

**2. No UK Reference Found**
```
❌ No UK scenario reference found for {scenario}
```
**Solution**: Verify UK scenario maps exist:
```bash
ls scenarios/UKNatureFrontierWithAir/United\ Kingdom/ScenarioMaps/
```

**3. Spatial Alignment Issues**
```
❌ Error cropping raster: Could not align raster stack
```
**Solution**: 
- Check coordinate systems match
- Verify input files are valid GeoTIFF format
- Ensure sufficient memory for large rasters

**4. Permission Errors**
```
❌ Permission denied: outputs/uk_results/{scenario}/
```
**Solution**: Check directory permissions:
```bash
chmod -R 755 outputs/uk_results/
```

### Validation Checks

**Verify UK Cropping Success**:
```bash
# Check file sizes (UK should be smaller than global)
ls -lh outputs/uk_results/*/nox_emissions*.tif

# Verify pixel counts are consistent across scenarios
grep "Total pixels:" outputs/uk_results/*/soil_nox_summary_uk.txt
```

**Check Spatial Alignment**:
```bash
# Use GDAL to verify extent
gdalinfo outputs/uk_results/extensification_current_practices/nox_emissions_uk.tif
```

## Integration Notes

### Workflow Integration
The UK post-processing can be:
1. **Standalone** - Run after global processing is complete
2. **Integrated** - Added to main processing pipeline
3. **Selective** - Run only for specific scenarios of interest

### Performance Considerations
- **Memory Usage**: UK cropping reduces memory requirements for subsequent analysis
- **Processing Time**: ~2-3 minutes per scenario on standard hardware
- **Storage**: UK files are ~50-80% smaller than global equivalents

### Quality Assurance
- **Spatial Validation**: UK bounds match land-use scenario extents
- **Statistical Validation**: Total emissions are subset of global totals
- **Cross-Scenario Consistency**: All scenarios have identical pixel counts and extents

---

## Quick Reference

### Essential Commands
```bash
# Single scenario
python soil_nox_scripts/soil_nox_uk_postprocessing.py {scenario_name}

# All scenarios
python soil_nox_scripts/batch_crop_uk_soil_nox.py

# With validation
python soil_nox_scripts/batch_crop_uk_soil_nox.py --validate
```

### Key Output Files
- `nox_emissions_uk.tif` - UK-cropped soil NOx emissions
- `soil_nox_summary_uk.txt` - UK-specific statistics
- `uk_cropping_summary.txt` - Batch processing summary

### Support
For issues or questions regarding the UK post-processing system, refer to this documentation or check the validation outputs for diagnostic information.